1936136:
  requires:
    - systemd: ceph-osd
      value: enabled
    - property: hotsos.core.plugins.storage.ceph.CephChecksBase.local_osds_use_bcache
    - property: hotsos.core.plugins.kernel.KernelChecksBase.version
      value: '5.4'
      op: lt
    - config:
        # NOTE: we need a way to check that actual osd config
        handler: hotsos.core.plugins.storage.ceph.CephConfig
        assertions:
          bluefs_buffered_io:
            value: true
            op: eq
    - config:
        handler: hotsos.core.plugins.storage.bcache.CachesetsConfig
        assertions:
          cache_available_percent:
            value: 70
            op: lt
    # Get version of osd based on package installed. This is prone to
    # inaccuracy since the daemon many not have been restarted after
    # package update.
    - apt:
        ceph-osd:
          - min: 13.0.2
            max: 14.2.9
          - min: 14.2.22
            max: 15.2.1
          - min: 15.2.13
            max: 16.1.0
          - min: 17.0.0
            max: 17.0.0
  raises:
    issue: hotsos.core.issues.CephCrushWarning
    message: >-
      This host has Ceph OSDs using bcache block devices and may be vulnerable
      to bcache bug LP 1936136. The current workaround is to set
      bluefs_buffered_io is set=False in Ceph or upgrade to a kernel >= 5.4.

