checks:
  bcache_enabled:
    requires:
      property: hotsos.core.plugins.storage.bcache.BcacheBase.bcache_enabled
  cset_has_invalid_config:
    requires:
      config:
        handler: hotsos.core.plugins.storage.bcache.CachesetsConfig
        invert-result: True
        assertions:
          congested_read_threshold_us:
            ops: [[eq, 0]]
          congested_write_threshold_us:
            ops: [[eq, 0]]
  cset_config_lp1900438_limit:
    requires:
      config:
        handler: hotsos.core.plugins.storage.bcache.CachesetsConfig
        assertions:
          # The real limit is 30 but we go just above in case bcache is flapping
          # just above and below the limit.
          cache_available_percent:
            ops: [[le, 33]]
conclusions:
  cset-has-invalid-config:
    decision:
      and:
        - bcache_enabled
        - cset_has_invalid_config
    raises:
      type: hotsos.core.issues.BcacheWarning
      message: >-
        bcache cacheset config {key} expected to be {op} but actual={value_actual}.
      format-dict:
        key: '@checks.cset_has_invalid_config.requires.key'
        op: '@checks.cset_has_invalid_config.requires.ops'
        value_actual: '@checks.cset_has_invalid_config.requires.value_actual'
  bcache-bug-lp1900438:
    decision:
      and:
        - bcache_enabled
        - cset_config_lp1900438_limit
    raises:
      type: hotsos.core.issues.BcacheWarning
      message: >-
        bcache cache_available_percent is {actual} (i.e. approx. 30%) which
        implies this node could be suffering from bug LP 1900438 - please check.
      format-dict:
        actual: '@checks.cset_config_lp1900438_limit.requires.value_actual'

