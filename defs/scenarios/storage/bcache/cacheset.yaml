checks:
  bcache_enabled:
    requires:
      property: core.plugins.storage.bcache.BcacheBase.bcache_enabled
  cset_has_invalid_config:
    requires:
      config:
        handler: core.plugins.storage.bcache.CachesetsConfig
        assertions:
          congested_read_threshold_us:
            value: 0
          congested_write_threshold_us:
            value: 0
      post-op: not_
  cset_config_lp1900438_limit:
    requires:
      config:
        handler: core.plugins.storage.bcache.CachesetsConfig
        assertions:
          # The real limit is 30 but we go just above in case bcache is flapping
          # just above and below the limit.
          cache_available_percent:
            value: 33
            op: le
conclusions:
  cset-has-invalid-config:
    decision:
      and:
        - bcache_enabled
        - cset_has_invalid_config
    raises:
      type: core.issues.BcacheWarning
      message: >-
        bcache cacheset config {key} expected to be {op} {value_expected} but
        actual={value_actual}.
      format-dict:
        key: '@checks.cset_has_invalid_config.requires.key'
        op: '@checks.cset_has_invalid_config.requires.op'
        value_expected: '@checks.cset_has_invalid_config.requires.value_expected'
        value_actual: '@checks.cset_has_invalid_config.requires.value_actual'
  bcache-bug-lp1900438:
    decision:
      and:
        - bcache_enabled
        - cset_config_lp1900438_limit
    raises:
      type: core.issues.BcacheWarning
      message: >-
        bcache cache_available_percent is {actual} (i.e. approx. 30%) which
        implies this node could be suffering from bug LP 1900438 - please check
      format-dict:
        actual: '@checks.cset_config_lp1900438_limit.requires.value_actual'

