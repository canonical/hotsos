checks:
  cpufreq_governor_not_performance:
    requires:
      and:
        # can we actually see the setting
        - property:
            path: hotsos.core.plugins.kernel.CPU.cpufreq_scaling_governor_all
            ops: [[ne, unknown]]
        # does it have the expected value
        - property:
            path: hotsos.core.plugins.kernel.CPU.cpufreq_scaling_governor_all
            ops: [[ne, performance]]
  is_neutron_gateway:
    # i.e. neutron-l3-agent but no nova == neutron gateway
    requires:
      - not:
          - apt: nova-compute
      - apt: neutron-l3-agent
  is_nova_compute:
    requires:
      apt: nova-compute
  ondemand_installed_and_enabled:
    requires:
      systemd:
        ondemand: enabled
conclusions:
  cpufreq-not-performance-n-cpu:
    priority: 1
    decision:
      and:
        - cpufreq_governor_not_performance
        - is_nova_compute
    raises:
      type: hotsos.core.issues.OpenstackWarning
      message: >-
        This node is used as an Openstack hypervisor but is not using cpufreq
        scaling_governor in "performance" mode (actual={governor}). This is not
        recommended and can result in performance degradation. To fix this you
        can install cpufrequtils, set "GOVERNOR=performance" in
        /etc/default/cpufrequtils and run systemctl restart cpufrequtils.
      format-dict:
        governor: hotsos.core.plugins.kernel.CPU.cpufreq_scaling_governor_all
  cpufreq-not-performance-n-gw:
    priority: 1
    decision:
      and:
        - cpufreq_governor_not_performance
        - is_neutron_gateway
    raises:
      type: hotsos.core.issues.OpenstackWarning
      message: >-
        This node is used as an Openstack Neutron Gateway but is not using cpufreq
        scaling_governor in "performance" mode (actual={governor}). This is not
        recommended and can result in performance degradation. To fix this you
        can install cpufrequtils, set "GOVERNOR=performance" in
        /etc/default/cpufrequtils and run systemctl restart cpufrequtils.
        NOTE: requires node reboot to take effect.
      format-dict:
        governor: hotsos.core.plugins.kernel.CPU.cpufreq_scaling_governor_all
  cpufreq-not-performance-with-ondemand-n-cpu:
    priority: 2
    decision:
      and:
        - cpufreq_governor_not_performance
        - is_nova_compute
        - ondemand_installed_and_enabled
    raises:
      type: hotsos.core.issues.OpenstackWarning
      message: >-
        This node is used as an Openstack hypervisor but is not using cpufreq
        scaling_governor in "performance" mode (actual={governor}). This is not
        recommended and can result in performance degradation. To fix this you
        can install cpufrequtils, set "GOVERNOR=performance" in
        /etc/default/cpufrequtils and run systemctl restart cpufrequtils. You
        will also need to stop and disable the ondemand systemd service in
        order for changes to persist.
      format-dict:
        governor: hotsos.core.plugins.kernel.CPU.cpufreq_scaling_governor_all
  cpufreq-not-performance-with-ondemand-n-gw:
    priority: 2
    decision:
      and:
        - cpufreq_governor_not_performance
        - is_neutron_gateway
        - ondemand_installed_and_enabled
    raises:
      type: hotsos.core.issues.OpenstackWarning
      message: >-
        This node is used as an Openstack Neutron Gateway but is not using cpufreq
        scaling_governor in "performance" mode (actual={governor}). This is not
        recommended and can result in performance degradation. To fix this you
        can install cpufrequtils, set "GOVERNOR=performance" in
        /etc/default/cpufrequtils and run systemctl restart cpufrequtils. You
        will also need to stop and disable the ondemand systemd service in
        order for changes to persist.
      format-dict:
        governor: hotsos.core.plugins.kernel.CPU.cpufreq_scaling_governor_all
