#!/usr/bin/python3
import re
import os

from common import (
    constants,
    helpers
)

EXT_EVENT_INFO = {}


def get_events(event_name):
    data_source = os.path.join(constants.DATA_ROOT,
                               "var/log/nova/nova-compute.log")
    if not os.path.exists(data_source):
        return

    key = (r".+\[instance: ([0-9a-z\-]+)\].+Preparing to wait for external "
           r"event ({}-[0-9a-z\-]+)\s+.+".format(event_name))  # noqa W605
    lines = open(data_source).readlines()

    events = {}
    ext_event_info = {}
    for line in lines:
        ret = re.compile(key).match(line)
        if ret:
            events[ret[2]] = ret[1]

    for event in events:
        if event_name not in ext_event_info:
            ext_event_info[event_name] = {}

        stages = {"Preparing": False, "Received": False, "Processing": False}
        for line in lines:
            ret = re.compile(r".+\[instance: {}\] .+ event {} .+"
                             .format(events[event], event)).match(line)
            if ret:
                sequence = ret[0]
                for stage in stages:
                    ret = re.compile(stage).search(sequence)
                    if ret:
                        stages[stage] = True

        if all([stages[stage] for stage in stages]):
            result = "succeeded"
        else:
            result = "failed"

        if result not in ext_event_info[event_name]:
            ext_event_info[event_name][result] = set()

        ext_event_info[event_name][result].add(events[event])

    if ext_event_info:
        for event in ext_event_info:
            if event not in EXT_EVENT_INFO:
                EXT_EVENT_INFO[event] = {}
            for result in ext_event_info[event]:
                s = ext_event_info[event][result]
                EXT_EVENT_INFO[event][result] = list(s)


if __name__ == "__main__":
    # Supported events - https://docs.openstack.org/api-ref/compute/?expanded=run-events-detail#create-external-events-os-server-external-events  # noqa E501
    get_events("network-vif-plugged")
    if EXT_EVENT_INFO:
        EXT_EVENT_INFO = {"os-server-external-events": EXT_EVENT_INFO}
        if not helpers.HOTSOSYaml.master_has_plugin("openstack"):
            EXT_EVENT_INFO = {"openstack": EXT_EVENT_INFO}
            indent = 0
        else:
            indent = 2

        helpers.HOTSOSYaml.dump(EXT_EVENT_INFO, indent=indent)
