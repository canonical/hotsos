name: hotsos
version: '1.0'
summary: Collect application operational information.
description:
  Software analysis toolkit. Define checks in high-level
  language and leverage library to perform analysis of
  common Cloud applications.
confinement: classic
grade: stable
base: core20
environment:
  LANG: C.UTF-8
  LC_ALL: C.UTF-8
  PYTHONHOME: ${SNAP}/usr
  PYTHONPATH: ${SNAP}/usr/lib/python3.8:${SNAP}/lib/python3.8/site-packages
  REPO_INFO_PATH: ${SNAP}/repo-info

# dpkg won't work without this
layout:
  /etc/dpkg/dpkg.cfg:
    bind-file: $SNAP_DATA/etc/dpkg/dpkg.cfg
  /etc/dpkg/dpkg.cfg.d:
    bind: $SNAP_DATA/etc/dpkg/dpkg.cfg.d

apps:
  hotsos:
    command: bin/hotsos

parts:
  hotsos:
    plugin: dump
    source: .
    build-packages:
      - git
      - python3-pip
      - python3-venv
    stage-packages:
      - bsdmainutils
      - coreutils
      - dpkg
      - libc6
      - libpython3.8-minimal
      - libpython3.8-stdlib
      - python3.8-minimal
      - systemd
    build-environment:
      - "CRYPTOGRAPHY_DONT_BUILD_RUST": "1"
    override-build: |
      git rev-parse --short HEAD > repo-info
      # In case we are debugging this snap and are running the build stage
      # multiple times, we have to guard against running venv multiple times.
      if [[ ! -x ${SNAPCRAFT_PART_INSTALL}/bin/activate ]]; then
        python3 -m venv ${SNAPCRAFT_PART_INSTALL}
      fi
      # Do not source `activate` so that consecutive rebuilding the snap (for
      # debugging) works.
      ${SNAPCRAFT_PART_INSTALL}/bin/pip install wheel
      ${SNAPCRAFT_PART_INSTALL}/bin/pip install -r requirements.txt
      ${SNAPCRAFT_PART_INSTALL}/bin/python3 setup.py install
      sed --in-place \
        --expression 's:^#!/root.*$:#!/snap/hotsos/current/usr/bin/python3.8:' \
        ${SNAPCRAFT_PART_INSTALL}/bin/hotsos
      ln -sf ../usr/bin/python3.8 ${SNAPCRAFT_PART_INSTALL}/bin/python3
      snapcraftctl build
    organize:
      defs: etc/hotsos/defs
    stage:
      # need to exclude these files since they are dangling symlinks
      # that cause the snapstore to reject the upload.
      - -lib/systemd/system/cryptdisks-early.service
      - -lib/systemd/system/cryptdisks.service
      - -lib/systemd/system/hwclock.service
      - -lib/systemd/system/rc.service
      - -lib/systemd/system/rcS.service
      - -lib/systemd/system/x11-common.service
      - -tests
