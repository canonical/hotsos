checks:
  is_not_sosreport_data_root: |
    @hotsos.core.plugins.sosreport.SOSReportChecks.data_root_is_sosreport != True
  is_ovn_central:
    apt: ovn-central
  neutron_ml2_ovn_enabled: |
    'ovn' IN read_ini('etc/neutron/plugins/ml2/ml2_conf.ini', 'mechanism_drivers')
  central_cert_exists: |
    file('etc/ovn/cert_host', 'exists')
  central_cert_expiring: |
    read_cert('etc/ovn/cert_host', 'days_to_expire') < 30
  is_neutron_server:
    apt: neutron-server
  neutron_cert_exists: |
    file('etc/neutron/plugins/ml2/cert_host', 'exists')
  neutron_cert_expiring: |
    read_cert('etc/neutron/plugins/ml2/cert_host', 'days_to_expire') < 30
conclusions:
  central_missing_cert:
    decision:
      - is_ovn_central
      - is_not_sosreport_data_root
      - not: central_cert_exists
    raises:
      type: OVNError
      message: >-
        This host is running ovn-central and is missing /etc/ovn/cert_host.
  neutron_missing_cert:
    decision:
      - is_neutron_server
      - neutron_ml2_ovn_enabled
      - is_not_sosreport_data_root
      - not: neutron_cert_exists
    raises:
      type: OVNError
      message: >-
        This host is running neutron-server and configured to use ml2-ovn but
        is missing /etc/neutron/plugins/ml2/cert_host.
  central_cert_expiring:
    decision:
      - is_ovn_central
      - central_cert_exists
      - central_cert_expiring
    raises:
      type: OVNError
      message: >-
        This ovn-central host's cert (/etc/ovn/cert_host) is going to expire in less than 30 days.
  neutron_cert_expiring:
    decision:
      - is_neutron_server
      - neutron_ml2_ovn_enabled
      - neutron_cert_exists
      - neutron_cert_expiring
    raises:
      type: OVNError
      message: >-
        This neutron-server host's ml2-ovn cert (/etc/neutron/plugins/ml2/cert_host)
        is going to expire in less than 30 days.
