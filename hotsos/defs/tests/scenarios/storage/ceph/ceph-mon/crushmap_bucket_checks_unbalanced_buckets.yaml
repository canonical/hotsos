target-name: crushmap_bucket_checks.yaml
data-root:
  files:
    sos_commands/ceph_mon/ceph_osd_crush_dump: |
        {
            "devices": [
                {
                    "id": 0,
                    "name": "osd.0",
                    "class": "ssd"
                },
                {
                    "id": 1,
                    "name": "osd.1",
                    "class": "ssd"
                },
                {
                    "id": 2,
                    "name": "osd.2",
                    "class": "ssd"
                },
                {
                    "id": 3,
                    "name": "osd.3",
                    "class": "ssd"
                },
                {
                    "id": 4,
                    "name": "osd.4",
                    "class": "ssd"
                },
                {
                    "id": 5,
                    "name": "osd.5",
                    "class": "ssd"
                },
                {
                    "id": 6,
                    "name": "osd.6",
                    "class": "ssd"
                },
                {
                    "id": 7,
                    "name": "osd.7",
                    "class": "ssd"
                },
                {
                    "id": 8,
                    "name": "osd.8",
                    "class": "ssd"
                },
                {
                    "id": 9,
                    "name": "osd.9",
                    "class": "ssd"
                },
                {
                    "id": 10,
                    "name": "osd.10",
                    "class": "ssd"
                },
                {
                    "id": 11,
                    "name": "osd.11",
                    "class": "ssd"
                },
                {
                    "id": 12,
                    "name": "osd.12",
                    "class": "ssd"
                },
                {
                    "id": 13,
                    "name": "osd.13",
                    "class": "ssd"
                },
                {
                    "id": 14,
                    "name": "osd.14",
                    "class": "ssd"
                },
                {
                    "id": 15,
                    "name": "osd.15",
                    "class": "ssd"
                },
                {
                    "id": 16,
                    "name": "osd.16",
                    "class": "ssd"
                },
                {
                    "id": 17,
                    "name": "osd.17",
                    "class": "ssd"
                },
                {
                    "id": 18,
                    "name": "osd.18",
                    "class": "ssd"
                },
                {
                    "id": 19,
                    "name": "osd.19",
                    "class": "ssd"
                },
                {
                    "id": 20,
                    "name": "osd.20",
                    "class": "ssd"
                },
                {
                    "id": 21,
                    "name": "osd.21",
                    "class": "ssd"
                },
                {
                    "id": 22,
                    "name": "osd.22",
                    "class": "ssd"
                },
                {
                    "id": 23,
                    "name": "osd.23",
                    "class": "ssd"
                },
                {
                    "id": 24,
                    "name": "osd.24",
                    "class": "ssd"
                },
                {
                    "id": 25,
                    "name": "osd.25",
                    "class": "ssd"
                },
                {
                    "id": 26,
                    "name": "osd.26",
                    "class": "ssd"
                },
                {
                    "id": 27,
                    "name": "osd.27",
                    "class": "ssd"
                },
                {
                    "id": 28,
                    "name": "osd.28",
                    "class": "ssd"
                },
                {
                    "id": 29,
                    "name": "osd.29",
                    "class": "ssd"
                },
                {
                    "id": 30,
                    "name": "osd.30",
                    "class": "ssd"
                },
                {
                    "id": 31,
                    "name": "osd.31",
                    "class": "ssd"
                },
                {
                    "id": 32,
                    "name": "osd.32",
                    "class": "ssd"
                },
                {
                    "id": 33,
                    "name": "osd.33",
                    "class": "ssd"
                },
                {
                    "id": 34,
                    "name": "osd.34",
                    "class": "ssd"
                },
                {
                    "id": 35,
                    "name": "osd.35",
                    "class": "ssd"
                }
            ],
            "types": [
                {
                    "type_id": 0,
                    "name": "osd"
                },
                {
                    "type_id": 1,
                    "name": "host"
                },
                {
                    "type_id": 2,
                    "name": "chassis"
                },
                {
                    "type_id": 3,
                    "name": "rack"
                },
                {
                    "type_id": 4,
                    "name": "row"
                },
                {
                    "type_id": 5,
                    "name": "pdu"
                },
                {
                    "type_id": 6,
                    "name": "pod"
                },
                {
                    "type_id": 7,
                    "name": "room"
                },
                {
                    "type_id": 8,
                    "name": "datacenter"
                },
                {
                    "type_id": 9,
                    "name": "zone"
                },
                {
                    "type_id": 10,
                    "name": "region"
                },
                {
                    "type_id": 11,
                    "name": "root"
                }
            ],
            "buckets": [
                {
                    "id": -1,
                    "name": "default",
                    "type_id": 11,
                    "type_name": "root",
                    "weight": 17169120,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -4,
                            "weight": 5723040,
                            "pos": 0
                        },
                        {
                            "id": -8,
                            "weight": 5723041,
                            "pos": 1
                        },
                        {
                            "id": -14,
                            "weight": 5723040,
                            "pos": 2
                        }
                    ]
                },
                {
                    "id": -2,
                    "name": "default~ssd",
                    "type_id": 11,
                    "type_name": "root",
                    "weight": 17169120,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -6,
                            "weight": 5723040,
                            "pos": 0
                        },
                        {
                            "id": -10,
                            "weight": 5723040,
                            "pos": 1
                        },
                        {
                            "id": -16,
                            "weight": 5723040,
                            "pos": 2
                        }
                    ]
                },
                {
                    "id": -3,
                    "name": "compute-server-4",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 0,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 6,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 12,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 18,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 26,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 27,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -4,
                    "name": "AZ1",
                    "type_id": 3,
                    "type_name": "rack",
                    "weight": 5723040,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -11,
                            "weight": 2861520,
                            "pos": 0
                        },
                        {
                            "id": -3,
                            "weight": 2861520,
                            "pos": 1
                        }
                    ]
                },
                {
                    "id": -5,
                    "name": "compute-server-4~ssd",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 0,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 6,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 12,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 18,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 26,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 27,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -6,
                    "name": "AZ1~ssd",
                    "type_id": 3,
                    "type_name": "rack",
                    "weight": 5723040,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -12,
                            "weight": 2861520,
                            "pos": 0
                        },
                        {
                            "id": -5,
                            "weight": 2861520,
                            "pos": 1
                        }
                    ]
                },
                {
                    "id": -7,
                    "name": "compute-server-5",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861521,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 2,
                            "weight": 476932,
                            "pos": 0
                        },
                        {
                            "id": 7,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 13,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 20,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 30,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 31,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -8,
                    "name": "AZ2",
                    "type_id": 3,
                    "type_name": "rack",
                    "weight": 5723041,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -19,
                            "weight": 2861520,
                            "pos": 0
                        },
                        {
                            "id": -7,
                            "weight": 2861521,
                            "pos": 1
                        }
                    ]
                },
                {
                    "id": -9,
                    "name": "compute-server-5~ssd",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 2,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 7,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 13,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 20,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 30,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 31,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -10,
                    "name": "AZ2~ssd",
                    "type_id": 3,
                    "type_name": "rack",
                    "weight": 5723040,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -20,
                            "weight": 2861520,
                            "pos": 0
                        },
                        {
                            "id": -9,
                            "weight": 2861520,
                            "pos": 1
                        }
                    ]
                },
                {
                    "id": -11,
                    "name": "compute-server-1",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 1,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 8,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 15,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 21,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 24,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 25,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -12,
                    "name": "compute-server-1~ssd",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 1,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 8,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 15,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 21,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 24,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 25,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -13,
                    "name": "compute-server-6",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 3,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 9,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 14,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 19,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 34,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 35,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -14,
                    "name": "AZ3",
                    "type_id": 3,
                    "type_name": "rack",
                    "weight": 5723040,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -17,
                            "weight": 2861520,
                            "pos": 0
                        },
                        {
                            "id": -13,
                            "weight": 2861520,
                            "pos": 1
                        }
                    ]
                },
                {
                    "id": -15,
                    "name": "compute-server-6~ssd",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 3,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 9,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 14,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 19,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 34,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 35,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -16,
                    "name": "AZ3~ssd",
                    "type_id": 3,
                    "type_name": "rack",
                    "weight": 5723040,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": -18,
                            "weight": 2861520,
                            "pos": 0
                        },
                        {
                            "id": -15,
                            "weight": 2861520,
                            "pos": 1
                        }
                    ]
                },
                {
                    "id": -17,
                    "name": "compute-server-3",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 4,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 10,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 16,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 22,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 32,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 33,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -18,
                    "name": "compute-server-3~ssd",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 4,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 10,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 16,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 22,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 32,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 33,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -19,
                    "name": "compute-server-2",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 5,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 11,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 17,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 23,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 28,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 29,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                },
                {
                    "id": -20,
                    "name": "compute-server-2~ssd",
                    "type_id": 1,
                    "type_name": "host",
                    "weight": 2861520,
                    "alg": "straw2",
                    "hash": "rjenkins1",
                    "items": [
                        {
                            "id": 5,
                            "weight": 476931,
                            "pos": 0
                        },
                        {
                            "id": 11,
                            "weight": 476931,
                            "pos": 1
                        },
                        {
                            "id": 17,
                            "weight": 476931,
                            "pos": 2
                        },
                        {
                            "id": 23,
                            "weight": 476931,
                            "pos": 3
                        },
                        {
                            "id": 28,
                            "weight": 476898,
                            "pos": 4
                        },
                        {
                            "id": 29,
                            "weight": 476898,
                            "pos": 5
                        }
                    ]
                }
            ],
            "rules": [
                {
                    "rule_id": 0,
                    "rule_name": "replicated_rule",
                    "ruleset": 0,
                    "type": 1,
                    "min_size": 1,
                    "max_size": 10,
                    "steps": [
                        {
                            "op": "take",
                            "item": -1,
                            "item_name": "default"
                        },
                        {
                            "op": "chooseleaf_firstn",
                            "num": 0,
                            "type": "rack"
                        },
                        {
                            "op": "emit"
                        }
                    ]
                }
            ],
            "tunables": {
                "choose_local_tries": 0,
                "choose_local_fallback_tries": 0,
                "choose_total_tries": 50,
                "chooseleaf_descend_once": 1,
                "chooseleaf_vary_r": 1,
                "chooseleaf_stable": 1,
                "straw_calc_version": 1,
                "allowed_bucket_algs": 54,
                "profile": "jewel",
                "optimal_tunables": 1,
                "legacy_tunables": 0,
                "minimum_required_version": "jewel",
                "require_feature_tunables": 1,
                "require_feature_tunables2": 1,
                "has_v2_rules": 0,
                "require_feature_tunables3": 1,
                "has_v3_rules": 0,
                "has_v4_buckets": 1,
                "require_feature_tunables5": 1,
                "has_v5_rules": 0
            },
            "choose_args": {}
        }
  copy-from-original:
    - sos_commands/date/date
    - sos_commands/systemd/systemctl_list-units
    - sos_commands/systemd/systemctl_list-unit-files
    - sos_commands/ceph_mon/ceph_report
mock:
  patch:
    hotsos.core.plugins.storage.ceph.CephCrushMap.autoscaler_disabled_pools:
      kwargs:
        new: true
    hotsos.core.plugins.storage.ceph.CephCluster.cluster_has_non_empty_pools:
      kwargs:
        new: true
raised-issues:
  CephCrushWarning: >-
    Found one or more unbalanced buckets in the cluster's CRUSH map. This can
    cause uneven data distribution or PG mapping issues in the cluster. Verify
    that "ceph osd crush tree --show-shadow" conforms to the expected layout
    for the cluster. Transient issues such as "out" OSDs, or cluster
    expansion/maintenance can trigger this warning. Affected CRUSH tree(s) and
    bucket types are tree 'default' at the 'rack' level.
